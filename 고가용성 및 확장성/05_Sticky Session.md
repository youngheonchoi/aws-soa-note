## 스티키 세션 (Sticky Session)

**스티키 세션**은 클라이언트가 로드 밸런서를 통해 백엔드에 접속할 때, **항상 동일한 인스턴스로 트래픽을 보내도록 유지**하는 기능입니다.  
이를 통해 사용자는 로그인 세션 같은 중요한 정보를 **끊김 없이** 유지할 수 있습니다.

<br>

## 주요 개념
- 기본적으로 로드 밸런서는 트래픽을 **모든 인스턴스에 분산**시킵니다.
- 스티키 세션을 활성화하면, **한 번 연결된 인스턴스로 계속 연결**됩니다.
- 구현 방식은 **쿠키 기반**입니다. 로드 밸런서 또는 애플리케이션이 쿠키를 생성하여 세션을 유지합니다.

<br>

## 사용 예시
예를 들어, ALB 뒤에 두 개의 EC2 인스턴스가 있고 클라이언트가 3명 있다고 가정해 봅시다:

| 클라이언트 | 첫 요청 → | 이후 요청 → |
|------------|------------|---------------|
| 클라이언트 1 | EC2-1 | EC2-1 |
| 클라이언트 2 | EC2-2 | EC2-2 |
| 클라이언트 3 | EC2-1 | EC2-1 |

> 이는 기본 로드 밸런싱 동작과는 다른 결과이며, 세션 유지가 필요한 웹 애플리케이션에서 중요합니다.

<br>

## 작동 방식

1. 클라이언트가 로드 밸런서에 요청을 보냄
2. **로드 밸런서 또는 애플리케이션이 쿠키 발급**
3. 쿠키에는 **타겟 인스턴스 정보**와 **만료 시간** 포함
4. 클라이언트는 이후 요청 시 이 쿠키를 함께 전송
5. 로드 밸런서는 이 쿠키를 기반으로 **동일한 인스턴스에 라우팅**

<br>

## 스티키 세션 활성화 대상

| 로드 밸런서 종류 | 지원 여부 |
|------------------|-----------|
| **ALB (Application Load Balancer)** | ✅ 지원 |
| **CLB (Classic Load Balancer)** | ✅ 지원 |
| **NLB (Network Load Balancer)** | ✅ 일부 지원 (TCP 연결 기반 고정 IP 유지)

<br>

## 쿠키의 두 가지 유형

| 쿠키 유형 | 생성 주체 | 설명 |
|-----------|-----------|------|
| **지속 시간 기반 쿠키** | 로드 밸런서 | 고정된 기간 동안 동일 인스턴스 유지<br>ALB: `AWSALB`<br>CLB: `AWSELB` |
| **애플리케이션 기반 쿠키** | 애플리케이션 | 직접 설정한 쿠키 이름으로 세션 유지<br>쿠키 이름은 사용자 정의, 단 예약어(`AWSALB`, `AWSALBAPP`, `AWSALBTG`) 사용 금지 |

> ALB에서 로드 밸런서가 직접 발급하는 쿠키의 이름은 `AWSALBAPP`입니다.

<br>

## 설정 방법 (ALB 기준)

1. **Target Group > 속성 편집** 메뉴 이동
2. **스티키 세션 활성화**
3. 쿠키 유형 선택
   - **로드 밸런서 기반**: 1초 ~ 7일 사이 지속 시간 설정
   - **애플리케이션 기반**: 커스텀 쿠키 이름 지정 (`MYCUSTOMCOOKIEAPP` 등)

> 변경 사항 저장 후, 쿠키 기반의 세션 유지가 작동함을 디버거(Network 탭 등)에서 확인 가능

<br>

## 확인 방법 (브라우저 개발자 도구)

- **Network 탭**에서 요청 및 응답의 쿠키 확인 가능
- 응답 쿠키: 로드 밸런서가 보낸 쿠키 정보
- 요청 쿠키: 클라이언트가 다시 로드 밸런서에 보낼 때 쿠키 포함

```plaintext
Set-Cookie: AWSALBAPP=XYZ...; Path=/; Expires=...
```

> 쿠키가 계속 브라우저에 유지되어 동일 인스턴스로 트래픽이 전달됨을 확인할 수 있음

<br>

## 주의 사항
- 스티키 세션을 활성화하면 **특정 인스턴스에만 트래픽이 몰릴 수 있음** → **부하 불균형 가능**
- 애플리케이션이 상태 저장 방식이라면 유리하지만, **무상태(stateless)** 아키텍처에는 불필요할 수도 있음

<br>

## 정리
스티키 세션은 **사용자 경험 유지를 위한 핵심 기능**으로, 세션 유지 또는 로그인 정보를 다루는 웹 애플리케이션에 적합합니다.  
**쿠키 기반 구현 방식**에 따라 로드 밸런서 또는 애플리케이션이 쿠키를 생성하며, 설정은 타겟 그룹 단위로 관리됩니다.  
장점은 **세션 일관성**, 단점은 **부하 불균형**입니다.