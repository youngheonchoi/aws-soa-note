## ASG 고급 개념 정리

### 1. 라이프사이클 후크 (Lifecycle Hooks)

* **ASG 인스턴스의 시작/종료 과정 사이에 사용자 정의 작업을 삽입할 수 있는 기능**
* 인스턴스는 기본적으로 `Pending` → `InService`로 바로 진입하지만, 후크를 설정하면 중간에 `Pending:Wait` 상태를 거쳐 사용자 스크립트를 실행할 수 있음
* 마찬가지로 종료 시 `Terminating:Wait` 상태를 통해 로그 백업, AMI 생성, 스냅샷, 기타 커스텀 작업을 할 수 있음

#### 사용 목적

* 인스턴스 초기화 작업
* 종료 전 로그 수집
* 장애 대응 및 디버깅

#### 트리거 방법

* **SNS**, **SQS**, **EventBridge**로 후크 이벤트를 전송
* 이 이벤트를 수신하여 **Lambda** 함수 등을 호출 가능

---

### 2. 시작 템플릿 (Launch Template) vs 시작 구성 (Launch Configuration)

| 항목       | Launch Configuration | Launch Template                       |
| -------- | -------------------- | ------------------------------------- |
| 수정 가능 여부 | 불가능 (매번 새로 생성)       | 버전 관리 가능, 일부 속성만 재사용 가능               |
| 기능 확장성   | 제한적                  | 온디맨드+스팟 혼합, 배치 그룹, 용량 예약, T2 무제한 등 지원 |
| 권장 여부    | 더 이상 사용되지 않음         | **Launch Template 사용 권장**             |

> 최신 기능을 사용하려면 항상 Launch Template을 선택해야 합니다

---

### 3. SQS 기반 스케일링

* SQS 대기열을 감시하여 메시지 수가 많아지면 **ASG 확장**
* CloudWatch 메트릭 `ApproximateNumberOfMessagesVisible` 기준으로 경보 생성 → 확장 정책 트리거
* 수평 확장을 유연하게 자동화할 수 있음

---

### 4. 헬스체크 종류 (ASG에서 사용 가능)

| 유형               | 설명                                                |
| ---------------- | ------------------------------------------------- |
| **EC2 상태 확인**    | 인스턴스 하드웨어/소프트웨어 기본 체크 (기본값)                       |
| **ELB 상태 확인**    | 대상 그룹에 연결된 인스턴스의 앱 응답 체크                          |
| **사용자 정의 상태 확인** | CLI/SDK를 통한 수동 상태 전송 (`SetInstanceHealth` API 사용) |

> 인스턴스가 비정상일 경우, ASG는 자동으로 종료하고 새 인스턴스를 시작
> 단, **재부팅되지 않고 종료 후 교체**

---

### 5. 자주 발생하는 문제 및 트러블슈팅

| 문제 상황              | 원인 및 해결 방법                                                                      |
| ------------------ | ------------------------------------------------------------------------------- |
| 인스턴스 시작 실패         | - 최대 용량 도달 → `MaxSize` 조정 필요<br>- AZ 용량 부족 → 다른 AZ 사용 고려<br>- 보안 그룹 또는 키 페어 삭제됨 |
| 인스턴스 24시간 이상 시작 실패 | ASG가 해당 프로세스를 **자동 중단** (디버깅을 위한 안전장치)                                          |
| 특정 리소스 누락          | 보안 그룹, 키페어, AMI 등 존재 여부 재확인 필요                                                  |

---

## 정리

* **Lifecycle Hook**은 인스턴스 시작/종료 시 작업 자동화의 핵심
* **Launch Template**은 시작 구성 대비 확장성, 유지보수성이 뛰어남
* **SQS 연동**, **커스텀 헬스체크**, **고급 트러블슈팅**은 실무에서도 매우 중요